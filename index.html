<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Musical Ball Bucket</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            touch-action: none;
            user-select: none;
            -webkit-user-select: none;
        }
        body {
            background: linear-gradient(135deg, #1a2a6c, #b21f1f, #fdbb2d);
            height: 100vh;
            overflow: hidden;
            font-family: Arial, sans-serif;
        }
        #game-info {
            position: fixed;
            top: 20px;
            right: 20px;
            color: white;
            font-size: 24px;
            background: rgba(0,0,0,0.3);
            padding: 10px 20px;
            border-radius: 10px;
            text-align: right;
            z-index: 100;
        }
        .ball {
            position: absolute;
            width: 30px;
            height: 30px;
            background: white;
            border-radius: 50%;
            pointer-events: none;
            box-shadow: 0 0 10px rgba(255,255,255,0.8);
        }
        .bucket {
            position: absolute;
            bottom: 50px;
            width: 100px;
            height: 80px;
            background: rgba(255,255,255,0.3);
            border: 3px solid white;
            border-radius: 0 0 15px 15px;
            left: 50%;
            transform: translateX(-50%);
            transition: width 0.3s ease;
            z-index: 50;
        }
        #start-btn {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            padding: 15px 30px;
            font-size: 20px;
            background: rgba(255,255,255,0.2);
            border: 2px solid white;
            color: white;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s;
            z-index: 100;
        }
        #start-btn:hover {
            background: rgba(255,255,255,0.3);
            transform: translate(-50%, -50%) scale(1.1);
        }
        #level {
            position: fixed;
            top: 20px;
            left: 20px;
            color: white;
            font-size: 24px;
            background: rgba(0,0,0,0.3);
            padding: 10px 20px;
            border-radius: 10px;
            z-index: 100;
        }
        @media (max-width: 768px) {
            #game-info, #level {
                font-size: 18px;
                padding: 8px 16px;
            }
            .bucket {
                bottom: 100px;
            }
        }
    </style>
</head>
<body>
    <div id="game-info">
        <div>Score: <span id="score">0</span></div>
        <div>High Score: <span id="high-score">0</span></div>
    </div>
    <div id="level">Level 1</div>
    <div class="bucket"></div>
    <button id="start-btn">Start Game</button>

    <script>
        class EnhancedBucketGame {
            constructor() {
                this.score = 0;
                this.highScore = parseInt(localStorage.getItem('highScore')) || 0;
                this.level = 1;
                this.isPlaying = false;
                this.bucket = document.querySelector('.bucket');
                this.scoreDisplay = document.getElementById('score');
                this.highScoreDisplay = document.getElementById('high-score');
                this.levelDisplay = document.getElementById('level');
                this.startBtn = document.getElementById('start-btn');
                
                // Game settings
                this.spawnInterval = 2000; // Start with 2 seconds between balls
                this.spawnTimer = null;
                
                // Piano notes in C major scale
                this.notes = [261.63, 293.66, 329.63, 349.23, 392.00, 440.00, 493.88, 523.25];
                this.melodyIndex = 0;
                
                // Audio setup
                this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                this.masterGain = this.audioContext.createGain();
                this.masterGain.connect(this.audioContext.destination);
                
                // Event listeners
                this.startBtn.addEventListener('click', () => this.startGame());
                
                // Mouse/touch movement
                this.setupControls();
                
                this.updateHighScore();
                
                // Handle page visibility
                document.addEventListener('visibilitychange', () => {
                    if (document.hidden) {
                        this.pauseGame();
                    } else {
                        this.resumeGame();
                    }
                });
            }

            setupControls() {
                // Mouse controls
                window.addEventListener('mousemove', (e) => this.moveBucket(e.clientX));
                
                // Touch controls
                window.addEventListener('touchmove', (e) => {
                    e.preventDefault();
                    const touch = e.touches[0];
                    this.moveBucket(touch.clientX);
                }, { passive: false });
                
                // Handle window resize
                window.addEventListener('resize', () => {
                    this.updateBucketPosition(this.bucket.offsetLeft);
                });
            }

            startGame() {
                this.isPlaying = true;
                this.score = 0;
                this.level = 1;
                this.updateScore();
                this.updateLevel();
                this.startBtn.style.display = 'none';
                this.bucket.style.width = '100px';
                
                // Start spawning balls
                this.startBallSpawn();
            }

            pauseGame() {
                this.isPlaying = false;
                if (this.spawnTimer) {
                    clearInterval(this.spawnTimer);
                }
            }

            resumeGame() {
                if (this.startBtn.style.display === 'none') {
                    this.isPlaying = true;
                    this.startBallSpawn();
                }
            }

            startBallSpawn() {
                if (this.spawnTimer) {
                    clearInterval(this.spawnTimer);
                }
                
                const spawnRate = Math.max(500, 2000 - (this.level - 1) * 200);
                this.spawnTimer = setInterval(() => this.spawnBall(), spawnRate);
            }

            spawnBall() {
                if (!this.isPlaying) return;
                
                const x = Math.random() * (window.innerWidth - 30);
                this.createBall(x, -30);
                this.playMelodyNote();
            }

            createBall(x, y) {
                const ball = document.createElement('div');
                ball.className = 'ball';
                ball.style.left = `${x}px`;
                ball.style.top = `${y}px`;
                document.body.appendChild(ball);

                let velocity = 1;
                const gravity = 0.2 * (1 + (this.level - 1) * 0.1);
                const horizontalSpeed = (Math.random() - 0.5) * (this.level * 2);

                let horizontalPos = x;

                const animate = () => {
                    if (!this.isPlaying) {
                        ball.remove();
                        return;
                    }

                    velocity += gravity;
                    const currentTop = parseFloat(ball.style.top);
                    const newTop = currentTop + velocity;
                    
                    horizontalPos += horizontalSpeed;
                    ball.style.left = `${horizontalPos}px`;
                    ball.style.top = `${newTop}px`;

                    const ballRect = ball.getBoundingClientRect();
                    const bucketRect = this.bucket.getBoundingClientRect();

                    if (this.checkCollision(ballRect, bucketRect)) {
                        this.score++;
                        this.updateScore();
                        this.playCollectSound();
                        this.checkLevelUp();
                        ball.remove();
                        return;
                    }

                    if (newTop > window.innerHeight || 
                        horizontalPos < -30 || 
                        horizontalPos > window.innerWidth) {
                        ball.remove();
                        return;
                    }

                    requestAnimationFrame(animate);
                };

                animate();
            }

            moveBucket(x) {
                if (!this.isPlaying) return;
                this.updateBucketPosition(x);
            }

            updateBucketPosition(x) {
                const bucketWidth = parseInt(this.bucket.style.width) || 100;
                const maxX = window.innerWidth - bucketWidth/2;
                const minX = bucketWidth/2;
                const newX = Math.max(minX, Math.min(x, maxX));
                this.bucket.style.left = `${newX}px`;
            }

            // ... (rest of the methods remain the same: checkCollision, playMelodyNote, 
            // playCollectSound, checkLevelUp, updateScore, updateHighScore, updateLevel)

            checkLevelUp() {
                const newLevel = Math.floor(this.score / 10) + 1;
                if (newLevel !== this.level) {
                    this.level = newLevel;
                    this.updateLevel();
                    this.playLevelUpSound();
                    
                    // Make bucket smaller and game faster
                    const newWidth = Math.max(40, 100 - (this.level - 1) * 5);
                    this.bucket.style.width = `${newWidth}px`;
                    this.startBallSpawn(); // Reset spawn timer with new rate
                }
            }

            playMelodyNote() {
                const osc = this.audioContext.createOscillator();
                const gainNode = this.audioContext.createGain();
                
                osc.connect(gainNode);
                gainNode.connect(this.masterGain);
                
                osc.type = 'sine';
                osc.frequency.setValueAtTime(this.notes[this.melodyIndex], this.audioContext.currentTime);
                this.melodyIndex = (this.melodyIndex + 1) % this.notes.length;
                
                gainNode.gain.setValueAtTime(0, this.audioContext.currentTime);
                gainNode.gain.linearRampToValueAtTime(0.3, this.audioContext.currentTime + 0.1);
                gainNode.gain.exponentialRampToValueAtTime(0.001, this.audioContext.currentTime + 0.5);
                
                osc.start();
                osc.stop(this.audioContext.currentTime + 0.5);
            }

            playCollectSound() {
                const osc = this.audioContext.createOscillator();
                const gainNode = this.audioContext.createGain();
                
                osc.connect(gainNode);
                gainNode.connect(this.masterGain);
                
                osc.type = 'sine';
                osc.frequency.setValueAtTime(this.notes[7], this.audioContext.currentTime);
                
                gainNode.gain.setValueAtTime(0, this.audioContext.currentTime);
                gainNode.gain.linearRampToValueAtTime(0.3, this.audioContext.currentTime + 0.05);
                gainNode.gain.exponentialRampToValueAtTime(0.001, this.audioContext.currentTime + 0.3);
                
                osc.start();
                osc.stop(this.audioContext.currentTime + 0.3);
            }

            checkCollision(ballRect, bucketRect) {
                return !(ballRect.right < bucketRect.left || 
                        ballRect.left > bucketRect.right || 
                        ballRect.bottom < bucketRect.top || 
                        ballRect.top > bucketRect.bottom);
            }

            updateScore() {
                this.scoreDisplay.textContent = this.score;
                if (this.score > this.highScore) {
                    this.highScore = this.score;
                    this.updateHighScore();
                }
            }

            updateHighScore() {
                localStorage.setItem('highScore', this.highScore);
                this.highScoreDisplay.textContent = this.highScore;
            }

            updateLevel() {
                this.levelDisplay.textContent = `Level ${this.level}`;
            }
        }

        new EnhancedBucketGame();
    </script>
</body>
</html>